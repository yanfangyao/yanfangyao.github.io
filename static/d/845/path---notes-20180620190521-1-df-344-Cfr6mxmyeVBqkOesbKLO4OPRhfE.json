{"data":{"site":{"siteMetadata":{"title":"William's Blog","author":"William"}},"markdownRemark":{"id":"fbd207b1-459e-5a0a-9351-34d451a7b2e1","excerpt":"解析CSS的流程 　　现代浏览器解析CSS文档的流程如图1所示。 　　现代浏览器解析CSS的流程与解析html的流程类似：从网络或者本地获取CSS文件后，经过解码器、预处理器、标记生成器以及树构建器处理之后生成一个CSSStyleSheet对象。解析流程中的关键处理步骤说明如下： \n　　（1）Byte Stream…","html":"<h2>解析CSS的流程</h2>\n<p>　　现代浏览器解析CSS文档的流程如图1所示。</p>\n<div style=\"text-align: center;\">\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9e93268e5bce7bb3004b6cd799202275/0f1a9/css_parsing_flow.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 66.64167916041978%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABcSAAAXEgFnn9JSAAACAElEQVQ4y2NgwAKi5txgAtHhs26Yp695879ow+v/Bete/M/c+OV//LyboSA5IM2cs+Q2A1HAvf8cI4j2nHDewKnnXGvUzMszo2ddnu/QfbbSre+cMEjOpReihiiQuug22IVJC2675C+/t6Bl86PlbVserchZdncJUMwVJJcGVANkE2eg35TLzCDad/Ll1MBpV76mL775Fojf+E+9/BMolwxTEzD1CnEGZiy8CfZO5qKbSmkLbvg3rr+X07LxXkHqghsBIDGYmvSFN4kzMGzmdbALA6ddK8xZ/+Z/6Zp7f8vX3v+dteHDf6BYPkwNEBNnoM8ESID7TTyn4tF3NjhjwdXirIVXy1x7zgQHTDqvAlMDxMQZGD/vFtiFcfNuJSfMv/WhYMW9J/kr7j4Csr8AxRLBaubfYo6dd4s4A936zjNBks95O2CymRw16/KC6FlXFgLZ0zz6L9jC1HhMuECcgVlL7oANzFh8xyF/+d0Z5avvLalcc28pkD0rfdFte4jcbaa0RXeIMzB4+lWwlwOmXcmImn3tT9y86x8TF9x4Hz3n+n//qVfSwHJTrxCfbLIW3QBHSu6Sm0pJ8675Vq66nV2x8lZhzKyrQZkLr4MjJX3BdUZgkiLOwPTFt5mhOSa3YO2z/znL7vzIXHLnTe7yu7/TFt9JAVu69A5z1BzMdAgAg44BbjPLyZoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"现代浏览器解析CSS的流程\"\n        title=\"\"\n        src=\"/static/9e93268e5bce7bb3004b6cd799202275/40fad/css_parsing_flow.png\"\n        srcset=\"/static/9e93268e5bce7bb3004b6cd799202275/707e9/css_parsing_flow.png 148w,\n/static/9e93268e5bce7bb3004b6cd799202275/649e0/css_parsing_flow.png 295w,\n/static/9e93268e5bce7bb3004b6cd799202275/40fad/css_parsing_flow.png 590w,\n/static/9e93268e5bce7bb3004b6cd799202275/b3fef/css_parsing_flow.png 885w,\n/static/9e93268e5bce7bb3004b6cd799202275/301c0/css_parsing_flow.png 1180w,\n/static/9e93268e5bce7bb3004b6cd799202275/0f1a9/css_parsing_flow.png 1334w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n</div>\n<div style=\"text-align: center;\">图 1 现代浏览器解析CSS的流程</div>\n<p>　　现代浏览器解析CSS的流程与解析html的流程类似：从网络或者本地获取CSS文件后，经过解码器、预处理器、标记生成器以及树构建器处理之后生成一个CSSStyleSheet对象。解析流程中的关键处理步骤说明如下：<br>\n　　（1）Byte Stream Decoder（字节流解码器）：将获取到的CSS字节流解析成Unicode编码表示的字符流。关于更多解码细节，可以<a href=\"https://www.w3.org/TR/css-syntax-3/#input-byte-stream\">查看CSS3标准</a>。<br>\n　　（2）Input Stream Preprocessor（输入字符流预处理器）：对解码产生的Unicode字符流进行预处理。主要进行如下两个操作：1、将所有的单个 “回车（CR）” 字符、“翻页（FF）” 字符以及 “回车换行（CRLF）” 字符对替换成单个 “换行（LF）” 字符。2、将所有的 “空（U+0000 NULL）” 字符替换成 “替换（U+FFFD REPLACEMENT CHARACTER）” 字符。<br>\n　　（3）Tokenizer（标记生成器）：处理步骤（2）生成的字符流，生成CSS标记并将标记传送给树生成器。CSS标记有多种，如标识符标记（&#x3C;ident-token>）、@标记（&#x3C;at-keyword-token>）、数字标记（&#x3C;number-token>）。CSS3标准给出了CSS标记的具体定义，可以<a href=\"https://www.w3.org/TR/css-syntax-3/#token-diagrams\">查看CSS3标准</a>来获得每个CSS标记的具体定义。标记生成器的标记化算法可以用状态机来表示，具体的算法实现流程可以参阅<a href=\"https://www.w3.org/TR/css-syntax-3/#tokenizer-algorithms\">CSS3标准</a>。<br>\n　　（4）Tree Construction（树构建）：根据标记生成器产生的一系列CSS标记，构建CSSOM树，树的根节点是CSSStyleSheet对象。CSSStyleSheet对象包含CSSRule对象，CSSRule对象又包含Selectors对象和Declaration对象以及其他与CSS语法对应的对象。<br></p>\n<h2>解析CSS示例</h2>\n<p>　　按照上述现代浏览器解析CSS文档的流程，以下CSS片段被解析之后生成的CSSOM树如图2所示。</p>\n<div class=\"gatsby-highlight\" data-language=\"css\"><pre class=\"language-css\"><code class=\"language-css\"><span class=\"token selector\">div</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">background</span><span class=\"token punctuation\">:</span> blue<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token selector\">div p</span> <span class=\"token punctuation\">{</span>\n   <span class=\"token property\">font-size</span><span class=\"token punctuation\">:</span> 16px<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div style=\"text-align: center;\">\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/daf52a76d51f5e166c88249e44616a27/086f1/test_CSSOM.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 58.81284070260448%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABcSAAAXEgFnn9JSAAACxElEQVQoz3VTa0hTYRg+c9NA04ikjH4UXQikH4F/SiQ0FLOaWdh2zjYv85a3qWkEBvojCDVXo5znbO5M18W85eUYM1EJ0h+juZ1dzs4mRaEFaklZ9KM/wdd7loti64OP93zv896e7zwfhv21FD2+oFUaPVGClZNsVvXwB6QZfIcaxtZQEe1bjc3VSgTs0p35P/FhCyfZoM29OYkRBo+4wMTFCGdZN5tS0svPVz4MLFQ88L8qNHH9qc1M9NWRZTHERctJlyiYT7nDi0o7XkTulj8oxtJoCZY/LIkEh4r+QzM04YVbUyLoXFVI+26rzT6dwujVEZT7qIBV0osSwDSAdQPWDlgbTroObU0oEuoQRrgCSBCKRM0ghMl1L2MIg3e5ceo7appYR1fGNhEEK4QkQm/fgRu8a03Wb6iJ+RjE5JRbGsSAPuSJIlIH5wmc8pyFnakwuE8qSGdcCCMoVzIkp8spTzbEncEp166wAjK9MzGr054kvccelpPugzWPl0SnWqxRmZ2Lu9Pb7YlSnX2ninJIFBQbl9Fm256ldewFX8KWGhLy7rNHcu46D2Rr7Xvwbmc8pqT9qHrgLaoZWkEqE4/yuxwZqh4uUD+2jmpBLmVPVgRfCm7w6DWTm6im/zWqGv8MV+FpgQHqNOMbqBp8taNrCGIYDC53oLTPz5T28Yyyhxu6rHcmg+0ss/ifw54GCVmBxX6gqgYdzpVb/KPwY+aAch7sHLWZnwafVd3Lz0JMY5B2YsXEtgiK+C2H49ex2KKn4jD//1YhzS2BYLtCZ6XR2wyT2aHrQrHZ9+y81rYPZKKHCSbSWmfiQehTxTTXISNdF8FnA3YOYKEnKPY0fDuxypFVVGTmZ0MFVSZu8pr1K6obeY/KHr1B57S2Y9DAVmoJ/EhtnUkqtwR+Cq9HRrpv1DFfUP34J1RA80tQsKSB2UC/AICdewGZK9dTAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"CSS解析示例\"\n        title=\"\"\n        src=\"/static/daf52a76d51f5e166c88249e44616a27/40fad/test_CSSOM.png\"\n        srcset=\"/static/daf52a76d51f5e166c88249e44616a27/707e9/test_CSSOM.png 148w,\n/static/daf52a76d51f5e166c88249e44616a27/649e0/test_CSSOM.png 295w,\n/static/daf52a76d51f5e166c88249e44616a27/40fad/test_CSSOM.png 590w,\n/static/daf52a76d51f5e166c88249e44616a27/b3fef/test_CSSOM.png 885w,\n/static/daf52a76d51f5e166c88249e44616a27/301c0/test_CSSOM.png 1180w,\n/static/daf52a76d51f5e166c88249e44616a27/086f1/test_CSSOM.png 1651w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n</div>\n<div style=\"text-align: center;\">图 2 CSS解析示例</div>\n<h2>构建呈现树</h2>\n<p>　　浏览器在解析构架DOM树的同时，还会构建呈现树。呈现树是由可视化元素按照其显示顺序组成的树，是文档的可视化表示。Firefox将呈现器中的元素称为 “框架(frame)“，Webkit将其称之为 “呈现器(renderer)” 或者 “呈现对象(render object)“。<br>\n　　呈现器（呈现对象）知道如何布局以及将自身及其子元素绘制出来。每一个呈现器都代表了一个矩形区域，通常对应于相关节点的CSS框，包含诸如宽度、高度、位置等几何信息。节点CSS样式中display属性的不同，浏览器创建出的呈现器的类型也不同，如inline和block。浏览器创建呈现器时也会考虑元素类型，有些特殊的元素类型对应特殊的呈现器（框架），如表单。</p>\n<h3>呈现树和DOM树的关系</h3>\n<p>　　呈现树与DOM树相对应，但并不是一一对应的。非可视化（注：不包括visibility属性值为hidden的元素）的元素（如head元素、display属性为none的元素）不会被插入到呈现树中。<br>\n　　对于一些具有复杂结构的元素，其无法用单一的矩形来描述，浏览器会为这些元素创建多个可视化对象。如select元素有3个呈现器：一个用于显示区域，一个用于下拉列表框，还有一个用于按钮。一个Text节点也可能对应多个可视化对象，如当宽度不够时，文本无法在一行中显示而分为多行，那么新的行也会作为新的呈现器而添加。<br>\n　　还有一些呈现对象在呈现树中所处的位置与DOM节点在DOM树中所处的位置并不对应。对于设置了浮动和定位的元素就会出现这种情况，这些元素处于文档的正常流程之外，其对应的呈现对象放置在呈现树的其他地方并映射到真正的呈现器（框架），放在原位的是占位框架。<br>\n　　图3显示了DOM树与呈现树的对应关系（<a href=\"https://www.html5rocks.com/en/tutorials/internals/howbrowserswork/#Render_tree_construction\">查看原文</a>）</p>\n<div style=\"text-align: center;\">\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a43a99a924a135f54b9ccd937b6c5de5/4ba2c/DOMTreevsRenderTree.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 54.17236662106703%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAACOElEQVQoz02Sy2sTQRzH8/cInjx7q6d6KAgi4kE8WXw/EGxRkaJi8WAPSkHFeiqiaKVqG6mWSFvb2tD0kbjdTTKb3W72kX3O7HN2d8ZJjOKHH3P4MZ/5zvCbAmWQnC0IfKm/OixMHhSeHdKX7qRphjGGDA/CANotuz3RroxXdh/sGlMGyQhTCmzJCEnZCZHVbH6dWpwsbkyD2nfbtl3Xjf4ShIH6Tl29sro5uumsOb1IWqA9utEZeWHBA3zrAlD0hohc12HVwzZtiKFRMjaGN/ZG9oJW0JdVjC/J8jAA5XabxnEl8E9Wq9dkmVNVyzDsP7bluKGrltTS9dLOvZ1IjvpyJ8XnQOOMwCk4YR0R49OCcENROkmC4zgIu/jQD7OQJa9dXuPv8qEY9mUpp0fFzkBD47Nugz1+CIDzophblsci7S4IopjG1g9reXiZu80l+0lfttHCPP94rv4QhfMK9qb3pc+1apH/NSnstSwTMt0xjbahLWuN9w2wALgPnFJU/JpPCCkY2tla5YjcHKL+1Rm5ekpwKCEOpsdEs6x5CaI4J4EVbE1sLY4sqt9UMAvWx9blN3JvVITmua3ro9vbJ0BjEDkXk0QKg5eAH+RqA4Zx3LQ/2WpQf8qXx8rWkmUWzep4VZvR+qNK0wjC14pyv16/6brP0wwmyYrjPmo2b0XRk5w0s4jqc5r+UU+EpLPSkd5K6CfqXpv+RxxTz2OFPI/9LaqqkSShfVkXW0DzNJQhL/R87P/b/xvvZj4P/lYDIwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"CSS解析示例\"\n        title=\"\"\n        src=\"/static/a43a99a924a135f54b9ccd937b6c5de5/40fad/DOMTreevsRenderTree.png\"\n        srcset=\"/static/a43a99a924a135f54b9ccd937b6c5de5/707e9/DOMTreevsRenderTree.png 148w,\n/static/a43a99a924a135f54b9ccd937b6c5de5/649e0/DOMTreevsRenderTree.png 295w,\n/static/a43a99a924a135f54b9ccd937b6c5de5/40fad/DOMTreevsRenderTree.png 590w,\n/static/a43a99a924a135f54b9ccd937b6c5de5/4ba2c/DOMTreevsRenderTree.png 731w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n</div>\n<div style=\"text-align: center;\">图 3 DOM树与呈现树的对应关系</div>\n　　在DOM树构建的过程中，浏览器遇到html或者body标记就会创建呈现树的根节点。这个根节点呈现对象对应于CSS的容器block，该block包含了所有其他的block，是最上层的block。这个block的尺寸就是浏览器的视口大小，Firefox称之为ViewPortFrame，Webkit称之为RenderView。呈现树的其余部分将会以DOM树节点插入的形式来创建。\n<h2>参考文献</h2>\n<ol>\n<li><a href=\"https://www.html5rocks.com/en/tutorials/internals/howbrowserswork/\">html5rocks: How Browsers Work: Behind the scenes of modern web browsers</a></li>\n<li><a href=\"https://www.w3.org/TR/html5/syntax.html\">HTML: The HTML syntax</a></li>\n</ol>","frontmatter":{"title":"现代浏览器的工作原理（三）","date":"June 20, 2018","description":"笔记（三）介绍了现代浏览器如何处理html文档，除了html文档之外，浏览器还需要处理样式文件，浏览器是如何解析css文件的呢？本博文对现代浏览器解析css文档的原理进行了详细阐述。"}}},"pageContext":{"slug":"/notes/20180620190521/","previous":{"fields":{"slug":"/notes/20180424213011/"},"frontmatter":{"title":"现代浏览器的工作原理（二）"}},"next":{"fields":{"slug":"/tips/20180713160854/"},"frontmatter":{"title":"react组件何时请求异步数据——componentWillMount或者componentDidMount?"}}}}