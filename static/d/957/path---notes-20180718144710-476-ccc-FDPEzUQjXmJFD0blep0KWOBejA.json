{"data":{"site":{"siteMetadata":{"title":"William's Blog","author":"William"}},"markdownRemark":{"id":"8291c9fe-649f-5d83-9982-3d297a0e33d4","excerpt":"sourcemap产生的背景 　　前端代码开发已经实现了模块化和工程化。为了减小静态资源体积，一般会选择将对js和css文件进行压缩形成一个或者多个bundle文件。压缩后的代码几乎不具有可毒性。这样会存在一个问题：当压缩后代码出现错误时，我们如何快速地定位到源码中出错的位置？sourcemap…","html":"<h2>sourcemap产生的背景</h2>\n<p>　　前端代码开发已经实现了模块化和工程化。为了减小静态资源体积，一般会选择将对js和css文件进行压缩形成一个或者多个bundle文件。压缩后的代码几乎不具有可毒性。这样会存在一个问题：当压缩后代码出现错误时，我们如何快速地定位到源码中出错的位置？sourcemap文件就是为了解决这种问题而被设计出来的。sourcemap在编译压缩后的bundle与源代码之间建立了一个映射关系，通过sourcemap可以很快地找到bundle中某一行代码在源代码中对应的位置。</p>\n<h2>sourcemap格式</h2>\n<p>　　sourcemap文件包含一个JSON对象，典型的数据结构如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"version\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"file\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"bundle.js\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"sourceRoot\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"sources\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"foo.js\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"bar.js\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"sourcesContent\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token null\">null</span><span class=\"token punctuation\">,</span> <span class=\"token null\">null</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"names\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"src\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"maps\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"are\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"fun\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"mappings\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"A,AAAB;;ABCDE;\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>　　对上述JSON对象的属性介绍如下：</p>\n<ul>\n<li><strong>version</strong>: sourcemap文件的版本号，取值为正整数。</li>\n<li><strong>file</strong>: sourcemap文件对应的bundle文件参数。</li>\n<li><strong>sourceRoot</strong>: sourcemap文件对应的源代码所在根目录。</li>\n<li><strong>sources</strong>: 源文件列表。</li>\n<li><strong>sourcesContent</strong>: 源文件内容列表，顺序与sources元素顺序对应。</li>\n<li><strong>names</strong>: 源代码中所有变量名和属性名列表。</li>\n<li><strong>mappings</strong>: 存储映射关系（<a href=\"/notes/20180314211238/\">Base 64编码</a>）。</li>\n</ul>\n<h2>sourcemap如何存储映射关系</h2>\n<p>　　sourcemap的mappings属性的值是将位置映射关系采用Base 64 VLQ编码后生成的字符串。mappings属性值包含的信息可以按照下面的方式进行拆分。<br>\n　　（1）生成的bundle文件中的每一行依次对应于mappings属性值中的一个组，组与组之间使用英文输入法中的分号分隔。上文所示的sourcemap示例中mappings包含三个组：<strong>“A,AAAB”</strong>、<strong>“空”</strong>和<strong>“ABCDE”</strong>，分别对应于bundle文件的第<strong>1、2、3</strong>行；<br>\n　　（2）mappings中每个组可以使用英文逗号分隔为多个段，如（1）中的第1组分为两个段，对应的字符序列分别为<strong>“A”</strong>和<strong>“AAAB”</strong>；<br>\n　　（3）每个段又可以看做是由5个可变长度域组成，段与可变长度域的关系可由图1表示。</p>\n<div style=\"text-aligin: center;\">\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/76d38b0a5fc0b8de44a6f7b846cf9767/045b1/segment_and_field.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 33.401920438957475%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABcSAAAXEgFnn9JSAAABe0lEQVQoz3VQyy5DYRj8Uo0EXWmbLoUjFo1rNETqGkmjUj20jbIXVFgRHoAFEi0PwEKsJPTQnlvTRZvGRjyBhbC18QL6j+8cJUQsJjPzz8x/LkT5GOh6tsoQDPzCVRSt5ioGSjuQCinb/+l87qr2PYp8Q01aBF4zLNxmGD5zytJwG2F4zGl4jRCCd0uIPWxhmNnD3jq3cm+t32xMw1ewWVAuDppUg1gs9IsFMyAmWMv6IJKFAJJGAKPqCGbUPkT0LuZejKnDmOdzK5e1QYxzP8k7ax9Sh0BZuUqvlXrgnAQUwkupASgRcMrQCI+lJqBY88xP5UYgx/qMUSY8l7l/yfqCxFvFCVc2ImjT6MRJvk1kNEls8JvsGR1I5ySkdQkreg8O9Hbs37TgkDmld+NIk+x8l3vr7DOqJI55v2344VSigijL360kBGUTsLXFSgI/vctYxr+58uXjgm7nQA4tBocivzMEA78R5afOwl9cQ92f7BvC3mtz1j+8/wBQiDOE+HprngAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"段与可变长度字段的关系\"\n        title=\"\"\n        src=\"/static/76d38b0a5fc0b8de44a6f7b846cf9767/40fad/segment_and_field.png\"\n        srcset=\"/static/76d38b0a5fc0b8de44a6f7b846cf9767/707e9/segment_and_field.png 148w,\n/static/76d38b0a5fc0b8de44a6f7b846cf9767/649e0/segment_and_field.png 295w,\n/static/76d38b0a5fc0b8de44a6f7b846cf9767/40fad/segment_and_field.png 590w,\n/static/76d38b0a5fc0b8de44a6f7b846cf9767/b3fef/segment_and_field.png 885w,\n/static/76d38b0a5fc0b8de44a6f7b846cf9767/301c0/segment_and_field.png 1180w,\n/static/76d38b0a5fc0b8de44a6f7b846cf9767/045b1/segment_and_field.png 1458w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n</div>\n<div style=\"text-align: center;\">图 1 段与可变长度域的关系</div>\n<p>　　域是可变长度的字符串的原因在于域值是Base 64 VLQ编码后生成的字符串(VLQ是变长编码)。域包含的信息如下：<br>\n　　（1）第一个字段表示的是段对应于bundle文件的第几列（从第0列开始计算）；<br>\n　　（2）第二个字段表示的是段对应的源文件在sources属性对应的源文件列表中的索引；<br>\n　　（3）第三个字段表示的是段对应于源文件的第几行（从第0行开始计算）；<br>\n　　（4）第四个字段表示的是段对应于源文件的第几列（从第0列开始计算）；<br>\n　　（5）第五个字段表示的是段对应的变量名或属性在names属性对应的变量名或属性列表中的索引。<br></p>\n<h2>Base 64 VLQ编码</h2>\n<p>　　VLQ编码是一种采用任意长度的二进制位来表示任意大小的整数的通用编码方式。<a href=\"/notes/20180314211238/\">Base 64编码</a>是将二进制序列分成多个由6个bit组成的数据块（不足补0）并将6bit数据映射成常见字符的编码方式。Base 64 VLQ编码结合了VLQ编码和Base 64编码的特点，它的编码特点如下：<br>\n　　（1）对任意整数编码后生成的结果是一个由Base 64字母表中的字符组成的任意长度的字符串。<br>\n　　（2）每一个字符对应6bit的二进制位。最高位取1时，表示该6bit后面的6bit和该6bit表示的是同一个整数，最高位取0时，表示整数的编码到该6bit结束。起始6bit的最低位起到标志整数符号的作用，0表示正数，1表示负数，其余的bit组的最低位当做数据位。<br></p>\n<h2>sourcemap mappings示例</h2>\n<p>　　假设某一个sourcemap的内容如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"version\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"file\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"index.min.js\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"sourceRoot\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"sources\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"page1.js\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"page2.js\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"names\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"b\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"c\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"d\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"mappings\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ABCDE;\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>　　对上述mappings解读如下：<br>\n　　（1）index.min.js只有一行，只对应于mappings中的一个组 “ABCDE” 。<br>\n　　（2）组 “ABCDE” 只包含一个段，“ABCDE”是对段中可变长度域的值进行Base 64 VLQ编码后的结果。<br>\n　　（3）将 “ABCDE” 逐个进行Base 64解码，可以得到如下二进制序列：000000 000010 000010 011010 000100。<br>\n　　（4）上述解码后得到的5个6bit二进制序列的最高位都为0，表示每一个整数只对应一个6bit单元。每个6bit单元的最低位都是0，表示每一个整数都是正数。上述二进制序列解码后得到的数字序列为0 1 1 13 2。<br>\n　　（5）根据段中域的含义，mappings展示出的信息如下：<strong>index.min.js的第1行第0列对应于page2.js文件的第1行第13列，这个位置对应的变量名为c</strong>。<br></p>\n<h2>如何关联bundle文件和sourcemap文件</h2>\n<p>　　有两种方法可以关联bundle文件和sourcemap文件：<br>\n　　（1）在bundle文件的http响应头部添加如下字段：<code class=\"language-text\">SourceMap: &lt;sourcemap url&gt;</code>。<br>\n　　（2）在bundle文件内部添加一行注释：<code class=\"language-text\">//# sourceMappingURL=&lt;sourcemap url&gt;</code>或<code class=\"language-text\">/*# sourceMappingURL=&lt;sourcemap url&gt; */</code>。</p>\n<h2>参考文献</h2>\n<ol>\n<li><a href=\"https://docs.google.com/document/d/1U1RGAehQwRypUTovF1KRlpiOFze0b-_2gc6fAH0KY0k/edit?hl=en_US&#x26;pli=1&#x26;pli=1#\">Source Map Revision 3 Proposal</a></li>\n<li><a href=\"https://www.html5rocks.com/en/tutorials/developertools/sourcemaps/\">Introduction to JavaScript Source Maps</a></li>\n<li><a href=\"http://www.ruanyifeng.com/blog/2013/01/javascript_source_map.html\">JavaScript Source Map 详解</a></li>\n<li><a href=\"https://en.wikipedia.org/wiki/Variable-length_code\">Wikipedia: Variable-length code</a></li>\n<li><a href=\"https://en.wikipedia.org/wiki/Variable-length_quantity\">Wikipedia: Variable-length quantity</a></li>\n</ol>","frontmatter":{"title":"sourcemap学习笔记","date":"July 18, 2018","description":"前端代码开发已经实现了模块化和工程化。为了减小静态资源体积，一般会选择将对js和css文件进行压缩形成一个或者多个bundle文件。压缩后的代码几乎不具有可毒性。这样会存在一个问题：当压缩后代码出现错误时，我们如何快速地定位到源码中出错的位置？sourcemap文件就是为了解决这种问题而被设计出来的。sourcemap在编译压缩后的bundle与源代码之间建立了一个映射关系，通过sourcemap可以很快地找到bundle中某一行代码在源代码中对应的位置。本博文对sourcemap原理进行了详细介绍。"}}},"pageContext":{"slug":"/notes/20180718144710/","previous":{"fields":{"slug":"/notes/20180717214533/"},"frontmatter":{"title":"meta标签学习笔记"}},"next":{"fields":{"slug":"/notes/20180824143040/"},"frontmatter":{"title":"MVC、MVP、MVVM软件架构学习笔记"}}}}