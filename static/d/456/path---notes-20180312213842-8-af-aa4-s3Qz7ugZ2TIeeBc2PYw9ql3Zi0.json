{"data":{"site":{"siteMetadata":{"title":"William's Blog","author":"William"}},"markdownRemark":{"id":"b56983ad-b20b-5342-ad29-64218615ee13","excerpt":"协议产生背景 　　http协议是一个单向、无连接、无状态的协议。因为协议的特性，在客户端需要即时获取服务端变动的业务场景下，http协议通信效率低下。为了弥补http协议这方面的缺陷，人们设计出了WebSocket协议。该协议建立在http协议的基础上，对http协议的功能进行了扩展。图1展示了WebSocket…","html":"<h2>协议产生背景</h2>\n<p>　　http协议是一个单向、无连接、无状态的协议。因为协议的特性，在客户端需要即时获取服务端变动的业务场景下，http协议通信效率低下。为了弥补http协议这方面的缺陷，人们设计出了WebSocket协议。该协议建立在http协议的基础上，对http协议的功能进行了扩展。图1展示了WebSocket协议和http协议的关系。</p>\n<div style=\"text-align: center;\">\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/07e7ff97417a607f47c3012b032b39a5/7d191/http_websocket.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 37.7959927140255%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABu0lEQVQoz12R2Y4SURRFq1GGAmouipoH4BbI0AxFMCHaaU2bGBPTb774A/7/DywPhfrgw07OvblZWXcfbdgxuWWgGbhDlywISCcJm+0Tl+t3mstXFrMjRbohcEusvs0ijXg3SznvKi6PM5pNxbJMqaIQTX8w/gEd3eZQx1RxQhqvUfMzanEmz/ZUZUOZn7D0UKAWZs8mmwQCn1IEHs7AwBs5aMOOxfCN1UL1tz6ZgKxRShwoimyLa8TU2ZRVEaHSkP0y57QuxapkVcaEvqIsTpID466H1tf6dLUeujbAdxXZ4oUwbqjyHYt5g2/GqCxiWSTtFz9fa54uikcB71ROHilm5b6tZNwVwzB5T1JeCcIDjpHh2ArXzOXBmjzdMrVDppZH4km3ftDOsTtpZ6NriYwu6dMToVt92uL0k8PzL6rtK75Xk1TPpOmBU/PC/viFIq5IXI8yDJknUdvbrXyVxfhjl4FARm1l99rky2OhD+XSFsMU26zEMGNeHSUnuTeZGK6Y+W0ixye0/TtMuy/072Jb4LDz5/AwxnWkw/obeXnh+vGVD59+sKrPZL5PHkzFUiJ2N8Pb+X/YLb8BMNPP1jIH8FcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"websocket协议与http协议的关系\"\n        title=\"\"\n        src=\"/static/07e7ff97417a607f47c3012b032b39a5/40fad/http_websocket.png\"\n        srcset=\"/static/07e7ff97417a607f47c3012b032b39a5/707e9/http_websocket.png 148w,\n/static/07e7ff97417a607f47c3012b032b39a5/649e0/http_websocket.png 295w,\n/static/07e7ff97417a607f47c3012b032b39a5/40fad/http_websocket.png 590w,\n/static/07e7ff97417a607f47c3012b032b39a5/b3fef/http_websocket.png 885w,\n/static/07e7ff97417a607f47c3012b032b39a5/301c0/http_websocket.png 1180w,\n/static/07e7ff97417a607f47c3012b032b39a5/b5a53/http_websocket.png 1770w,\n/static/07e7ff97417a607f47c3012b032b39a5/7d191/http_websocket.png 2196w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n</div>\n<div style=\"text-align: center;\">图1 WebSocket协议与http协议的关系</div>\n<h2>建立WebSocket通信</h2>\n<h3>客户端</h3>\n<p>　　HTML5将WebSocket协议标准化，目前各大主流浏览器均已支持WebSocket协议。浏览器提供了一个<a href=\"https://developer.mozilla.org/en-US/docs/Web/API/WebSocket\">WebSocket对象</a>用来创建和管理WebSocket连接。客户端可以利用这一对象与服务器进行WebSocket通信。一个简单的客户端建立WebSocket通信的代码如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// Create WebSocket connection.</span>\n<span class=\"token keyword\">const</span> socket <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WebSocket</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ws://localhost:3000'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Connection opened</span>\nsocket<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'open'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'websocket协议握手成功！！！'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Listen for messages</span>\nsocket<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'message'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'收到新消息！！！'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Connection closed</span>\nsocket<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'close'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'停止websocket协议！！！'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>服务端</h3>\n<p>　　目前，针对不同的服务器环境均有对应的WebSocket框架可以使用，详情可见<a href=\"https://en.wikipedia.org/wiki/Comparison_of_WebSocket_implementations\">维基百科</a>。适用于Node环境的WebSocket框架主要有以下几类：</p>\n<ul>\n<li><strong><a href=\"https://github.com/websockets/ws\">ws</a></strong></li>\n<li><strong><a href=\"https://github.com/uNetworking/uWebSockets\">uWebSockets</a></strong></li>\n<li><strong><a href=\"https://socket.io/\">socket.io</a></strong></li>\n</ul>\n<p>　　以Node环境下的<strong><a href=\"https://github.com/websockets/ws\">ws</a></strong>框架为例，一个简单的服务器端实现WebSocket协议的示例代码如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// import http module</span>\n<span class=\"token keyword\">const</span> http <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// import ws</span>\n<span class=\"token keyword\">const</span> websocket <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ws'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// create http server</span>\n<span class=\"token keyword\">const</span> server <span class=\"token operator\">=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">.</span><span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// create websocket instance</span>\n<span class=\"token keyword\">const</span> websocketServer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">websocket<span class=\"token punctuation\">.</span>Server</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>server<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// listen for connection</span>\nwebsocketServer<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'connection'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>ws<span class=\"token punctuation\">,</span> req<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// listen for messages</span>\n    ws<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'message'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"收到了新消息！！！\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        ws<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">'您好，我已经收到了你的消息'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>WebSocket协议握手</h3>\n<p>　　WebSocket协议使用了http协议的握手通道，由http协议升级到WebSocket协议时的http报文示例如下：</p>\n<ul>\n<li>\n<p><strong>request</strong></p>\n<div style=\"text-align: center\">\n</li>\n</ul>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/24802716c8898a405bcca37a58137c73/175e8/websocket_request.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 41.37404580152672%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABSUlEQVQoz51Sa4+CQAzk//+2C4JCQEUPUFAeu7DAISo41zbxw325S26TSZt9TKfTtbIsw2azgeu6iOMYRVHicDwiv1zR9wOmacLj8cD9fpf4er1+hWWMwXq9hkekQRAiSc9QuoHpOnR9L6TjOEq83Sb8tSylNTzPI1Wf2O4PRHjC6ZyhqmtcSe3lWkApjaKsJGflZVWjImT5Becsl8hnfN9qW4PtLkKcpPD8AB+2Iyr5IZMwqlpJgZLymvKmaQXvIgzOubCllKJWA1KVE+kJKakbx5vgP8vS1LJt2/B9H2G4JdKEFKZCfowTxGQBt9IPg3jLyliJpjjPs5D8GMqbcLVawXFcan8nHvFAjOkETMaXn0TwfM5EtGBZFtnj+IYQNk1DRA72UYSQvOShsF/sIUf2jBVqUjcMX2jpV3ARLspn/Bt4DqyebfoGeZldNc/eyYgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"websocket协议握手时http请求报文\"\n        title=\"\"\n        src=\"/static/24802716c8898a405bcca37a58137c73/40fad/websocket_request.png\"\n        srcset=\"/static/24802716c8898a405bcca37a58137c73/707e9/websocket_request.png 148w,\n/static/24802716c8898a405bcca37a58137c73/649e0/websocket_request.png 295w,\n/static/24802716c8898a405bcca37a58137c73/40fad/websocket_request.png 590w,\n/static/24802716c8898a405bcca37a58137c73/b3fef/websocket_request.png 885w,\n/static/24802716c8898a405bcca37a58137c73/301c0/websocket_request.png 1180w,\n/static/24802716c8898a405bcca37a58137c73/175e8/websocket_request.png 1310w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n</div>\n<ul>\n<li>\n<p><strong>response</strong></p>\n<div style=\"text-align: center;\">\n</li>\n</ul>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3d53dbe030b0a0caf79ad3f2b72d4cf1/08646/websocket_response.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 11.094224924012158%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsSAAALEgHS3X78AAAAYElEQVQI13WMMQ6AIBAE+f8DEVQK7IgcUEAiBFiFWOokk612mDEGnHNIKbErBec9rLXwPqCUgitn5NdaK3rvaK3N/ZKllGZwEQJy3aD1gRjTEw4zSuRAzuG0NKODcfzjBj6/mbvFnF1JAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"websocket协议握手时http响应报文\"\n        title=\"\"\n        src=\"/static/3d53dbe030b0a0caf79ad3f2b72d4cf1/40fad/websocket_response.png\"\n        srcset=\"/static/3d53dbe030b0a0caf79ad3f2b72d4cf1/707e9/websocket_response.png 148w,\n/static/3d53dbe030b0a0caf79ad3f2b72d4cf1/649e0/websocket_response.png 295w,\n/static/3d53dbe030b0a0caf79ad3f2b72d4cf1/40fad/websocket_response.png 590w,\n/static/3d53dbe030b0a0caf79ad3f2b72d4cf1/b3fef/websocket_response.png 885w,\n/static/3d53dbe030b0a0caf79ad3f2b72d4cf1/301c0/websocket_response.png 1180w,\n/static/3d53dbe030b0a0caf79ad3f2b72d4cf1/08646/websocket_response.png 1316w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n</div>\n<p>　　上述http报文中与WebSocket协议握手阶段相关的字段解释如下：</p>\n<div style=\"text-align: center;\">表1 WebSocket协议握手阶段http报文首部相关字段解释</div>\n<table>\n<thead>\n<tr>\n<th align=\"center\">字段名称</th>\n<th align=\"center\">含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">Connection: Upgrade</td>\n<td align=\"center\">表示要升级协议。</td>\n</tr>\n<tr>\n<td align=\"center\">Upgrade:websocket</td>\n<td align=\"center\">表示要升级到WebSocket协议。</td>\n</tr>\n<tr>\n<td align=\"center\">Sec-WebSocket-Extensions</td>\n<td align=\"center\">仅用在WebSocket连接握手阶段。它先由客户端(浏览器)发送到服务器，然后再由服务器传回客户端，以便协商连接过程中的协议层扩展集。可能在HTTP请求中出现多次(等价于出现一次，但有多个值)，但是最多只能在HTTP响应中出现一次。</td>\n</tr>\n<tr>\n<td align=\"center\">Sec-WebSocket-Key</td>\n<td align=\"center\">Base64编码字符串，与服务端响应首部的Sec-WebSocket-Accept是配套的，提供基本的防护，比如恶意的连接，或者无意的连接。</td>\n</tr>\n<tr>\n<td align=\"center\">Sec-WebSocket-Version</td>\n<td align=\"center\">表示websocket的版本。如果服务端不支持该版本，需要返回一个Sec-WebSocket-Version首部字段，里面包含服务端支持的版本号。</td>\n</tr>\n<tr>\n<td align=\"center\">Sec-WebSocket-Accept</td>\n<td align=\"center\">Base64编码字符串，根据客户端请求首部的Sec-WebSocket-Key计算出来。</td>\n</tr>\n</tbody>\n</table>\n<p>　　Sec-WebSocket-Accept字段计算公式：</p>\n<ol>\n<li>将Sec-WebSocket-Key跟258EAFA5-E914-47DA-95CA-C5AB0DC85B11拼接。</li>\n<li>通过SHA1计算出摘要，并转成base64字符串。伪代码：toBase64(sha1(Sec-WebSocket-Key + 258EAFA5-E914-47DA-95CA-C5AB0DC85B11))。</li>\n</ol>\n<h2>参考文献</h2>\n<ol>\n<li><a href=\"http://www.ruanyifeng.com/blog/2017/05/websocket.html\">WebSocket 教程</a></li>\n<li><a href=\"https://www.zhihu.com/question/20215561\">知乎：WebSocket 是什么原理？为什么可以实现持久连接？</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/rKvoevbSmtAUoCgOH2lZdQ\">WebSocket：5分钟从入门到精通</a></li>\n<li><a href=\"http://blog.csdn.net/tennysonsky/article/details/44562435\">如何理解HTTP协议的 “无连接，无状态” 特点？</a></li>\n<li><a href=\"https://blog.lyz810.com/article/2016/06/websocket-handshake-server-response/\">WebSocket协议详解及应用(三)-WebSocket握手协议之服务器响应</a></li>\n</ol>","frontmatter":{"title":"WebSocket协议学习笔记","date":"March 12, 2018","description":"http协议是一个单向、无连接、无状态的协议。因为协议的特性，在客户端需要即时获取服务端变动的业务场景下，http协议通信效率低下。为了弥补http协议这方面的缺陷，人们设计出了WebSocket协议。该协议建立在http协议的基础上，对http协议的功能进行了扩展。本文详细介绍了WebSocket协议的基本概念及其使用方法。"}}},"pageContext":{"slug":"/notes/20180312213842/","previous":{"fields":{"slug":"/translate/20180202205143/"},"frontmatter":{"title":"为什么setTimeout和setInterval的实际延时比设置的时间长"}},"next":{"fields":{"slug":"/notes/20180314211238/"},"frontmatter":{"title":"Base-64编码学习笔记"}}}}